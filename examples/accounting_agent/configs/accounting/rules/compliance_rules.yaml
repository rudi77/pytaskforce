# Compliance Rules for DACH & EU Invoice Validation
# Based on §14 UStG (DE) and general EU VAT Directive
# Version: 1.1

version: "1.1"
legal_basis: "§14 Abs. 4 UStG / Art. 226 MwStSystRL"

# Mandatory fields
mandatory_fields:
  # Nr. 1 - Name und Anschrift des leistenden Unternehmers
  supplier_name:
    legal_ref: "§14 Abs. 4 Nr. 1 UStG"
    description: "Vollständiger Name des leistenden Unternehmers"
    severity: "error"
    required: true

  supplier_address:
    legal_ref: "§14 Abs. 4 Nr. 1 UStG"
    description: "Vollständige Anschrift des leistenden Unternehmers"
    severity: "error"
    required: true

  # Nr. 2 - Steuernummer oder USt-IdNr.
  vat_id:
    legal_ref: "§14 Abs. 4 Nr. 2 UStG"
    description: "Umsatzsteuer-Identifikationsnummer (EU-Format)"
    severity: "error"
    required: true
    validation:
      # UPDATE: Erlaubt alle EU-Formate (z.B. DE123..., ATU123..., NL123...)
      # Regex: 2 Großbuchstaben (Länderkürzel) gefolgt von 2-12 alphanumerischen Zeichen
      pattern_vat_id: "^([A-Z]{2})[0-9A-Za-z\\+\\*\\.]{2,12}$"
      # Fallback für deutsche Steuernummern
      pattern_tax_number: "^\\d{2,3}/\\d{3}/\\d{5}$"

  # Nr. 3 - Ausstellungsdatum
  invoice_date:
    legal_ref: "§14 Abs. 4 Nr. 3 UStG"
    description: "Ausstellungsdatum der Rechnung"
    severity: "error"
    required: true

  # Nr. 4 - Fortlaufende Rechnungsnummer
  invoice_number:
    legal_ref: "§14 Abs. 4 Nr. 4 UStG"
    description: "Fortlaufende Rechnungsnummer"
    severity: "error"
    required: true

  # Nr. 5 - Menge und Art der Lieferung
  quantity_description:
    legal_ref: "§14 Abs. 4 Nr. 5 UStG"
    description: "Menge und Art der Lieferung/Leistung"
    severity: "error"
    required: true

  # Nr. 7/8 - Beträge
  net_amount:
    legal_ref: "§14 Abs. 4 Nr. 7 UStG"
    severity: "error"
    required: true

  vat_rate:
    legal_ref: "§14 Abs. 4 Nr. 8 UStG"
    severity: "error"
    required: true

  # Getränke und Verpflegung (Betrieblich)
  office_refreshments:
    keywords:
      - "Mineralwasser"
      - "Wasser"
      - "Kaffee"
      - "Tee"
      - "Milch"
      - "Zucker"
      - "Getränke"
      - "Cola"
      - "Limonade"
      - "Bier"      # Achtung: Alkohol oft kritisch, aber buchbar
      - "Kasten"
      - "Pfand"
    debit_account: "4980"  # SKR03: Betriebsbedarf
    debit_name: "Betriebsbedarf (Getränke)"
    legal_basis: "§4 Abs. 4 EStG (Betriebliche Übung)"

# Kontext-Logik für Auslandsrechnungen
context_logic:
  foreign_supplier:
    # Wenn der Lieferant NICHT aus DE kommt (erkennbar an USt-ID != DE...)
    action: "downgrade_severity"
    reason: "Ausländische Rechnung - §14 UStG Formvorschriften gelten nur eingeschränkt für Vorsteuerabzug"
    check_instead:
      - "Reverse Charge Hinweis (§13b UStG)"
      - "Innergemeinschaftliche Lieferung"

# Warnungen statt Fehler
warnings:
  - field: "delivery_date"
    message: "Leistungsdatum fehlt oder unklar"
    severity: "warning" # Herabgestuft von Error, da oft "Leistungsmonat" reicht