# Accounting Agent Configuration
# German Accounting Assistant for invoice processing and Kontierung
# Version: 2.0 - Skill-based Smart Booking Workflow
#
# Usage:
#   taskforce run mission "Prüfe die Rechnung invoice.pdf" --profile accounting_agent
#
# Or programmatically:
#   factory = AgentFactory()
#   agent = await factory.create_agent(profile="accounting_agent")

profile: accounting_agent

# =============================================================================
# SYSTEM PROMPT (Reduziert - Skills übernehmen Workflow-Details)
# =============================================================================

system_prompt: |
  # Buchhaltungs-Assistent (German Accounting Agent – BENNU)

  Du bist ein spezialisierter Buchhaltungs-Assistent für deutsches Steuer- und Handelsrecht.
  Du unterstützt Menschen sowohl beim **Verstehen** von Rechnungen als auch bei der **Verarbeitung**.

  ## INTENT-ERKENNUNG (SCHRITT 1 - IMMER ZUERST!)

  Klassifiziere JEDE User-Anfrage in genau einen dieser Intents:

  ### INVOICE_QUESTION
  User möchte etwas über die Rechnung wissen, aber KEINE Verarbeitung.

  Beispiele:
  - "Wie hoch ist die MwSt?"
  - "Wer ist der Lieferant?"
  - "Warum zwei Steuersätze?"
  - "Was bedeutet diese Position?"

  → **Aktiviere Skill:** `invoice-explanation`

  ### ACCOUNTING_QUESTION
  User stellt allgemeine Fragen zur Buchhaltung, Kontierung oder Steuerrecht,
  ohne eine konkrete Rechnung zu verarbeiten.

  Beispiele:
  - "Wie kontiere ich Bewirtungskosten?"
  - "Wann ist Vorsteuerabzug möglich?"
  - "Was bedeutet Reverse Charge?"

  → **Aktiviere Skill:** `accounting-expert`

  ### INVOICE_PROCESSING
  User möchte die Rechnung prüfen, kontieren oder buchen.

  Beispiele:
  - "Bitte verbuchen"
  - "Prüfe die Rechnung"
  - "Erstelle einen Buchungsvorschlag"
  - "Ist die Rechnung gültig?"

  → **Aktiviere Skill:** `smart-booking-auto`

  ## SKILL-AKTIVIERUNG (SCHRITT 2)

  Nach Intent-Erkennung:
  1. Aktiviere den passenden Skill
  2. Folge den Skill-Instruktionen **EXAKT**
  3. Der Skill definiert den kompletten Workflow

  ## SKILL-WECHSEL (AUTOMATISCH)

  Der `smart-booking-auto` Skill wechselt automatisch zu `smart-booking-hitl` wenn:
  - Confidence < 95%
  - Hard Gate ausgelöst (new_vendor, high_amount, critical_account)

  Du musst den Wechsel NICHT manuell initiieren - folge einfach den Skill-Instruktionen.

  ## KRITISCHE REGELN

  1. **INTENT ZUERST** - Bestimme IMMER den Intent bevor du handelst
  2. **SKILL FOLGEN** - Führe den Skill-Workflow exakt aus
  3. **KEIN EIGENMÄCHTIGES HANDELN** - Keine Buchungen ohne Skill-Anweisung
  4. **HITL RESPEKTIEREN** - Bei ask_user IMMER auf Antwort warten!

  ## ⛔ ABSOLUTE PFLICHT BEI HITL ⛔

  Wenn `confidence_evaluator` `recommendation: hitl_review` zurückgibt ODER
  wenn `booking_proposals` leer ist:

  **DU MUSST DAS TOOL `ask_user` AUFRUFEN!**

  Die Reihenfolge ist IMMER:
  1. `hitl_review(action="create")` → Review erstellen
  2. **SOFORT DANACH:** `ask_user(question="...")` → **PFLICHT! User befragen**
  3. Warten auf User-Antwort (Ausführung pausiert automatisch)
  4. Nach Resume: `hitl_review(action="process")` → Review abschließen
  5. `rule_learning` → Aus Interaktion lernen

  ## ⚠️ WICHTIG: Nach hitl_review(action="create") ⚠️

  **DEIN ALLERNÄCHSTER TOOL-CALL MUSS `ask_user` SEIN!**

  Beispiel für ask_user:
  ```
  ask_user(question="Buchungsvorschlag zur Prüfung:

  Lieferant: [Name]
  Rechnungsnummer: [Nummer]
  Bruttobetrag: [Betrag] EUR

  Kein passende Regel gefunden.

  Bitte wählen:
  1. Konto eingeben (z.B. 4930 für Büromaterial)
  2. Ablehnen")
  ```

  **OHNE `ask_user` DARFST DU:**
  - ❌ KEINE Buchung abschließen
  - ❌ KEINE Regel erstellen
  - ❌ KEIN Konto selbst wählen
  - ❌ KEINEN audit_log erstellen
  - ❌ NICHT mit final_answer beenden

# =============================================================================
# SKILLS CONFIGURATION
# =============================================================================

skills:
  # Skill-Verzeichnisse
  directories:
    - "${PLUGIN_PATH}/skills"

  # Verfügbare Skills
  available:
    - name: invoice-explanation
      description: "Beantwortet Fragen zu Rechnungen ohne Workflow"
      trigger: "INVOICE_QUESTION"

    - name: accounting-expert
      description: "Allgemeine Buchhaltungsfragen (Kontierung, Steuerrecht)"
      trigger: "ACCOUNTING_QUESTION"

    - name: smart-booking-auto
      description: "Automatischer Buchungsworkflow (Confidence >=95%)"
      trigger: "INVOICE_PROCESSING"

    - name: smart-booking-hitl
      description: "Human-in-the-Loop Workflow (Confidence <95% oder Hard Gate)"
      trigger: "AUTO_SWITCH"  # Wird automatisch von smart-booking-auto aktiviert

  # Skill-Aktivierung
  activation:
    mode: "intent_based"  # Skills werden basierend auf Intent aktiviert
    auto_switch: true     # Automatischer Wechsel zwischen Skills erlaubt

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

persistence:
  type: file
  work_dir: .taskforce_accounting

# =============================================================================
# AGENT BEHAVIOR CONFIGURATION
# =============================================================================

agent:
  max_steps: 50
  planning_strategy: plan_and_execute
  planning_strategy_params:
    max_step_iterations: 4
    max_plan_steps: 12

# =============================================================================
# LLM CONFIGURATION
# =============================================================================

llm:
  config_path: configs/llm_config.yaml
  default_model: main

# =============================================================================
# TOOL CONFIGURATION
# =============================================================================

tools:
  # Skill activation tool (must be first - LLM calls this after intent recognition)
  - activate_skill

  # Core extraction and validation tools
  - docling_extract
  - invoice_extract
  - calculate_tax
  - audit_log

  # Compliance checker with rules
  - name: check_compliance
    params:
      rules_path: "${PLUGIN_PATH}/configs/accounting/rules/compliance_rules.yaml"

  # Semantic Rules Engine (PRD Phase 1)
  - name: semantic_rule_engine
    params:
      rules_path: "${PLUGIN_PATH}/configs/accounting/rules/"

  - name: confidence_evaluator
    params:
      auto_book_threshold: 0.95
      high_amount_threshold: 5000.0
      critical_accounts: ["1800", "2100"]

  - rag_fallback
  - hitl_review
  - rule_learning

  # Native taskforce tools
  - file_read
  - ask_user

# =============================================================================
# WORKFLOW CONFIGURATION (PRD Phase 1)
# =============================================================================

workflow:
  # Confidence threshold for automatic booking (no HITL required)
  auto_book_threshold: 0.95

  # Hard gates that always trigger HITL review
  hard_gates:
    new_vendor: true
    high_amount_threshold: 5000  # EUR
    critical_accounts:
      - "1800"  # Privatentnahmen
      - "2100"  # Anzahlungen

  # Enable automatic rule learning from high-confidence bookings
  auto_rule_learning: true
  min_confidence_for_rule_learning: 0.95

  # Enable rule learning from HITL corrections
  learn_from_hitl: true

# =============================================================================
# EMBEDDINGS CONFIGURATION (Azure OpenAI)
# =============================================================================

embeddings:
  provider: azure
  deployment_name: text-embedding-ada-002
  api_version: "2024-02-01"
  cache_enabled: true
  cache_max_size: 1000

# =============================================================================
# CONTEXT POLICY
# =============================================================================

context_policy:
  max_items: 50
  max_chars_per_item: 8000
  truncation_strategy: "trim_oldest"

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

logging:
  level: INFO
  structured: true

# =============================================================================
# LONG-TERM MEMORY CONFIGURATION (via MCP)
# =============================================================================

# mcp_servers:
#   - type: stdio
#     command: npx
#     args:
#       - "-y"
#       - "@modelcontextprotocol/server-memory"
#     env:
#       MEMORY_FILE_PATH: ".taskforce_accounting/.memory/knowledge_graph.jsonl"
#     description: "Accounting knowledge: suppliers, rules, projects, user preferences"
