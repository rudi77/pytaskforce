# Accounting Agent Configuration
# German Accounting Assistant for invoice processing and Kontierung
# Version: 2.0 - Skill-based Smart Booking Workflow
#
# Usage:
#   taskforce run mission "Prüfe die Rechnung invoice.pdf" --profile accounting_agent
#
# Or programmatically:
#   factory = AgentFactory()
#   agent = await factory.create_agent(profile="accounting_agent")

profile: accounting_agent

# =============================================================================
# SYSTEM PROMPT (Reduziert - Skills übernehmen Workflow-Details)
# =============================================================================

system_prompt: |
  Du bist ein erfahrener Buchhalter fuer deutsches Steuerrecht (SKR03).
  Du verarbeitest Rechnungen effizient und triffst eigenstaendige Buchungsentscheidungen
  auf Basis gelernter Regeln, Memory und fachlicher Expertise.

  ## Kommunikations-Routing

  | Empfaenger | Kanal | Wann |
  |------------|-------|------|
  | Telegram-User | `ask_user(question=..., channel="telegram", recipient_id="<sender_id>")` | Fehlende Pflichtangaben (§14 UStG): Datum, Steuernr, Lieferant, Rechnungsnr, Betraege, MwSt, Leistung |
  | Buchhalter (CLI) | `ask_user(question=...)` (ohne channel) | Buchungsentscheidungen, HITL-Reviews, Hard Gates |
  | Telegram-User (Info) | `send_notification(...)` | Ergebnis-Benachrichtigungen (auto-booked, HITL-Ergebnis, Fehler) |

  ## Entscheidungslogik (Kaskade)

  1. `semantic_rule_engine` hat Matches -> nutze diese via `confidence_evaluator`
  2. Keine Regel-Matches ABER Memory-Regel passt -> nutze Memory mit `memory_confirmed=true` via `confidence_evaluator`
  3. Weder Regeln noch Memory -> HITL-Review (Buchhalter fragen)

  Bei `workflow_completed: true` + `recommendation: auto_book` -> sofort buchen, NICHT den User fragen.
  Bei `recommendation: hitl_review` -> `hitl_review(action="create")`, dann Buchhalter per Standard-`ask_user` fragen,
  dann `hitl_review(action="process")` + `rule_learning` + `audit_log` + `send_notification`.

  ## Resume-Regeln nach ask_user (KRITISCH)

  Wenn du nach einem `ask_user` fortgesetzt wirst, ist die Nachricht die ANTWORT auf deine Rueckfrage.
  Du MUSST: Antwort in die laufende Rechnung einarbeiten -> `check_compliance` erneut -> Workflow fortsetzen.
  VERBOTEN: Neuen Workflow starten, `activate_skill` mit erfundenen Pfaden aufrufen, PDF-Pfade halluzinieren.
  Reicht die Antwort nicht, stelle eine praezisere Rueckfrage.

  ## Memory-Nutzung

  - Lade Memory EINMAL zu Beginn der Session (`memory(action="list")`).
  - Lade erneut NUR wenn der User Regeln aendert oder neue Praeferenzen definiert.
  - Beim Schreiben: Zuerst `memory(action="search")`, dann `update` statt `add` wenn aehnlicher Eintrag existiert.
  - Prioritaet: User-Regeln > Vendor-Generalisierung > RAG-Vorschlag

  ## Goldene Regeln

  - Wenn eine Aktion noetig ist, IMMER das Tool aufrufen — nie nur Text antworten.
  - `confidence_evaluator` NIE ueberspringen, auch bei Memory-Match.
  - Antworte knapp und sachlich, nicht prozedural.

# =============================================================================
# SKILLS CONFIGURATION
# =============================================================================

skills:
  # Skill-Verzeichnisse
  directories:
    - "${PLUGIN_PATH}/skills"

  # Verfügbare Skills
  available:
    - name: invoice-explanation
      description: "Beantwortet Fragen zu Rechnungen ohne Workflow"
      trigger: "INVOICE_QUESTION"

    - name: accounting-expert
      description: "Allgemeine Buchhaltungsfragen (Kontierung, Steuerrecht)"
      trigger: "ACCOUNTING_QUESTION"

    - name: smart-booking-auto
      description: "Automatischer Buchungsworkflow (Confidence >=95%)"
      trigger: "INVOICE_PROCESSING"

    - name: smart-booking-hitl
      description: "Human-in-the-Loop Workflow (Confidence <95% oder Hard Gate)"
      trigger: "AUTO_SWITCH"  # Wird automatisch von smart-booking-auto aktiviert

  # Skill-Aktivierung
  activation:
    mode: "intent_based"  # Skills werden basierend auf Intent aktiviert
    auto_switch: true     # Automatischer Wechsel zwischen Skills erlaubt

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

persistence:
  type: file
  work_dir: .taskforce_accounting

# =============================================================================
# AGENT BEHAVIOR CONFIGURATION
# =============================================================================

agent:
  max_steps: 25
  planning_strategy: native_react  # Flexibler, weniger LLM-Calls
  max_parallel_tools: 3            # Parallelisierung aktivieren

# =============================================================================
# LLM CONFIGURATION
# =============================================================================

llm:
  config_path: configs/llm_config.yaml
  default_model: main

# =============================================================================
# TOOL CONFIGURATION
# =============================================================================

tools:
  # Skill activation tool (must be first - LLM calls this after intent recognition)
  - activate_skill

  # Core extraction and validation tools
  - docling_extract
  - invoice_extract
  - calculate_tax
  - audit_log

  # Compliance checker with rules
  - name: check_compliance
    params:
      rules_path: "${PLUGIN_PATH}/configs/accounting/rules/compliance_rules.yaml"

  # Semantic Rules Engine (PRD Phase 1)
  - name: semantic_rule_engine
    params:
      rules_path: "${PLUGIN_PATH}/configs/accounting/rules/"

  - name: confidence_evaluator
    params:
      auto_book_threshold: 0.95
      high_amount_threshold: 5000.0
      critical_accounts: ["1800", "2100"]

  - rag_fallback
  - hitl_review
  - rule_learning

  # Native taskforce tools
  - file_read
  - ask_user
  - send_notification

  - memory


# Unified Memory Configuration
memory:
  store_dir: ".taskforce_accounting/memory.md"

# =============================================================================
# WORKFLOW CONFIGURATION (PRD Phase 1)
# =============================================================================

workflow:
  # Confidence threshold for automatic booking (no HITL required)
  auto_book_threshold: 0.95

  # Hard gates that always trigger HITL review
  hard_gates:
    new_vendor: true
    high_amount_threshold: 5000  # EUR
    critical_accounts:
      - "1800"  # Privatentnahmen
      - "2100"  # Anzahlungen

  # Enable automatic rule learning from high-confidence bookings
  auto_rule_learning: true
  min_confidence_for_rule_learning: 0.95

  # Enable rule learning from HITL corrections
  learn_from_hitl: true

# =============================================================================
# EMBEDDINGS CONFIGURATION (LiteLLM - provider-agnostic)
# =============================================================================

embeddings:
  provider: litellm
  model: azure/text-embedding-3-small  # Azure OpenAI deployment name
  cache_enabled: true
  cache_max_size: 1000

# =============================================================================
# CONTEXT POLICY
# =============================================================================

context_policy:
  max_items: 50
  max_chars_per_item: 8000
  truncation_strategy: "trim_oldest"

# =============================================================================
# CONTEXT MANAGEMENT
# =============================================================================

context_management:
  summary_threshold: 40          # ~3-4 invoices before compression
  compression_trigger: 80000     # Framework default - don't destroy critical context
  max_tool_output_chars: 15000   # Invoices need more room than default

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

logging:
  level: INFO
  structured: true

# =============================================================================
# LONG-TERM MEMORY CONFIGURATION (via MCP)
# =============================================================================

# mcp_servers:
#   - type: stdio
#     command: npx
#     args:
#       - "-y"
#       - "@modelcontextprotocol/server-memory"
#     env:
#       MEMORY_FILE_PATH: ".taskforce_accounting/.memory/knowledge_graph.jsonl"
#     description: "Accounting knowledge: suppliers, rules, projects, user preferences"
