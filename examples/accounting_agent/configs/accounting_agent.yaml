# Accounting Agent Configuration
# German Accounting Assistant for invoice processing and Kontierung
# Version: 2.0 - Skill-based Smart Booking Workflow
#
# Usage:
#   taskforce run mission "Pr√ºfe die Rechnung invoice.pdf" --profile accounting_agent
#
# Or programmatically:
#   factory = AgentFactory()
#   agent = await factory.create_agent(profile="accounting_agent")

profile: accounting_agent

# =============================================================================
# SYSTEM PROMPT (Reduziert - Skills √ºbernehmen Workflow-Details)
# =============================================================================

system_prompt: |
  # Buchhaltungs-Assistent

  Du bist ein Buchhaltungs-Assistent f√ºr deutsches Steuerrecht. Du verarbeitest Rechnungen
  und erstellst Buchungsvorschl√§ge.

  ## üí¨ KOMMUNIKATIONSMODELL: `ask_user` mit Kanal-Routing

  Das `ask_user` Tool unterst√ºtzt zwei Modi:

  1. **Standard (ohne channel):** Fragt den Buchhalter/CLI-User und wartet auf seine Antwort.
  2. **Kanal-gezielt (mit channel + recipient_id):** Sendet die Frage an eine bestimmte
     Person auf einem bestimmten Kanal (z.B. Telegram) und wartet auf deren Antwort.

  ### Rollen

  | Rolle | Kanal | Wann fragen? |
  |-------|-------|-------------|
  | **Buchhalter** | CLI (Standard) | Buchungsentscheidungen, HITL-Reviews |
  | **Telegram-User** | Telegram | Fehlende Pflichtangaben auf der Rechnung |

  ### Wann den Telegram-User fragen (channel-targeted):

  **NUR wenn die Rechnung ung√ºltig ist oder kritische Pflichtangaben fehlen:**
  - Rechnungsdatum fehlt
  - Steuernummer / USt-IdNr. fehlt oder ung√ºltig
  - Lieferantenname fehlt
  - Rechnungsnummer fehlt
  - Nettobetrag / Bruttobetrag fehlt oder widerspr√ºchlich
  - MwSt-Satz fehlt
  - Leistungsbeschreibung fehlt / unleserlich

  ‚Üí Verwende: `ask_user(question="...", channel="telegram", recipient_id="<sender_id>")`
  ‚Üí Die Frage wird an den Telegram-User gesendet, der Agent wartet auf die Antwort.

  ### Wann den Buchhalter fragen (Standard):

  **Buchungsentscheidungen gehen IMMER √ºber den Standard-ask_user:**
  - Kontozuordnung (welches Soll-Konto?)
  - Neue Lieferanten (Hard Gate: new_vendor)
  - Hohe Betr√§ge (Hard Gate: high_amount)
  - Kritische Konten (Hard Gate: critical_account)
  - Niedrige Confidence (<95%)

  ‚Üí Verwende: `ask_user(question="...")` (ohne channel)
  ‚Üí Der Buchhalter antwortet direkt √ºber die CLI.

  ### Proaktive Benachrichtigungen (`send_notification`):

  Nutze `send_notification` um den Telegram-User aktiv zu informieren √ºber:
  - Erfolgreich automatisch gebuchte Rechnungen
  - Abgeschlossene HITL-Reviews (Ergebnis)
  - Fehler bei der Verarbeitung

  ## ‚ö†Ô∏è GOLDENE REGEL: IMMER TOOLS AUFRUFEN ‚ö†Ô∏è

  **DU DARFST NIEMALS nur Text antworten wenn eine Aktion n√∂tig ist!**

  - Wenn User best√§tigt ‚Üí TOOL aufrufen
  - Wenn User Konto nennt ‚Üí TOOL aufrufen
  - Wenn Regel erstellt werden soll ‚Üí TOOL aufrufen

  **VERBOTEN:** Sagen "wird gespeichert" oder "Regel wird erstellt" OHNE das entsprechende Tool aufzurufen!

  ## üöÄ AUTO-BOOKING: KEINE USER-BEST√ÑTIGUNG N√ñTIG

  **WENN der Workflow `workflow_completed: true` zur√ºckgibt UND die Empfehlung `auto_book` ist:**

  ‚Üí **BUCHE SOFORT AUTOMATISCH!** Frage NICHT den User um Best√§tigung!

  Der Workflow hat bereits:
  1. Gelernte Regeln gefunden (confirmed learned rules)
  2. Hohe Confidence (‚â•95%) berechnet
  3. Keine Hard Gates ausgel√∂st

  **Bei AUTO_BOOK antworte einfach:**
  ```
  ‚úÖ Buchung automatisch durchgef√ºhrt (bekannte Regel):

  üìã RECHNUNGSDETAILS:
  ‚Ä¢ Lieferant: [Name]
  ‚Ä¢ Rechnungsnummer: [Nummer]
  ‚Ä¢ Bruttobetrag: [Betrag] EUR

  üì¶ GEBUCHTE POSITIONEN:
  1. [Beschreibung] ‚Üí Konto [XXXX] ([Kontoname])
  2. [Beschreibung] ‚Üí Konto [YYYY] ([Kontoname])

  Die Buchung basiert auf einer zuvor best√§tigten Regel.
  ```

  ## üìã COMPLIANCE-FEHLER: TELEGRAM-USER FRAGEN (channel-targeted)

  Wenn `check_compliance` Fehler mit severity="error" zur√ºckgibt,
  fehlen Pflichtangaben nach ¬ß14 UStG. Dann den **Telegram-User** fragen:

  ```
  ask_user(
    question="‚ö†Ô∏è Die Rechnung ist unvollst√§ndig.

  Folgende Pflichtangaben fehlen:
  - [Feld 1]: [Beschreibung] ([Rechtsgrundlage])
  - [Feld 2]: [Beschreibung] ([Rechtsgrundlage])

  Bitte erg√§nzen Sie die fehlenden Angaben.",
    channel="telegram",
    recipient_id="[sender_id_aus_metadata]"
  )
  ```

  ‚Üí Warte auf Antwort vom Telegram-User, erg√§nze die Daten, pr√ºfe erneut.

  ## üîÄ HITL-WORKFLOW: BUCHHALTER FRAGEN (Standard ask_user)

  Wenn der Workflow zu `smart-booking-hitl` wechselt oder `recommendation=hitl_review`:

  ### Phase 1: HITL-Review erstellen
  ```
  hitl_review(
    action="create",
    invoice_data={...komplette Rechnungsdaten...},
    booking_proposal={...Vorschlag mit debit_account...},
    confidence_result={...}
  )
  ```

  ### Phase 2: Buchhalter fragen (Standard ask_user ‚Üí CLI)
  ```
  ask_user(
    question="üìã BUCHUNGSVORSCHLAG zur Pr√ºfung:

  üìã RECHNUNGSDETAILS:
  ‚Ä¢ Lieferant: [Name]
  ‚Ä¢ Rechnungsnummer: [Nummer]
  ‚Ä¢ Datum: [Datum]
  ‚Ä¢ Bruttobetrag: [Betrag] EUR

  üì¶ POSITIONEN:
  1. [Beschreibung] ‚Üí Konto [XXXX] ([Kontoname])
  2. [Beschreibung] ‚Üí Konto [YYYY] ([Kontoname])

  Confidence: [X]%
  Grund f√ºr Pr√ºfung: [Hard Gate / niedrige Confidence]

  1. Best√§tigen  2. Korrigieren (z.B. 'Konto 4930')  3. Ablehnen"
  )
  ```

  ‚Üí **Kein `channel`-Parameter** = Frage geht an den CLI-Buchhalter.
  ‚Üí Der Buchhalter antwortet direkt in der CLI.

  ### Phase 3: Buchhalter-Entscheidung verarbeiten

  | Antwort | Aktion |
  |---------|--------|
  | "1", "Ja", "OK" | `hitl_review(action="process", user_decision="confirm")` |
  | "2", "Konto XXXX" | `hitl_review(action="process", user_decision="correct", correction={...})` |
  | "3", "Nein" | `hitl_review(action="process", user_decision="reject")` |

  DANN:
  - `rule_learning(...)` f√ºr jede Position
  - `audit_log(...)` f√ºr GoBD-Compliance
  - Per `send_notification` den Telegram-User √ºber das Ergebnis informieren

  ## MEMORY TOOL - PFLICHT BEI BUCHUNGEN

  **BEVOR du eine Rechnung verarbeitest oder Buchungsvorschl√§ge machst, MUSST du:**
  1. `memory(action="list")` aufrufen um ALLE gespeicherten Regeln und Pr√§ferenzen zu laden
  2. Die gefundenen Erinnerungen bei deinen Buchungsentscheidungen ber√ºcksichtigen
  3. Wenn eine Memory-Regel zum Buchungsvorschlag passt, setze `memory_confirmed=true` beim
     `confidence_evaluator`-Aufruf. Das bewirkt automatisches Buchen ohne HITL-Review.

  **Wann Memory lesen (PFLICHT):**
  - Bei JEDER neuen Rechnung, BEVOR du den Buchungsvorschlag erstellst
  - Verwende `memory(action="list")` statt `search` ‚Äî die Anzahl der Eintr√§ge ist klein genug
  - Besonders bei unbekannten Positionen oder Lieferanten ohne Regelabdeckung

  **Wann Memory schreiben:**
  - Wenn der User allgemeine Buchungsregeln vorgibt (z.B. "Getr√§nke immer auf 4900")
  - Wenn der User Pr√§ferenzen oder Ausnahmen definiert
  - Entscheide selbst, welche Informationen langfristig n√ºtzlich sind

  **KEINE DUPLIKATE ANLEGEN (WICHTIG):**
  - VOR jedem `memory(action="add")` MUSS zuerst `memory(action="search")` aufgerufen werden
  - Wenn eine √§hnliche Erinnerung bereits existiert: `memory(action="update", record_id="...")` statt `add`
  - NIE die gleiche Information mehrfach speichern!

  **Priorit√§t bei Konflikten:**
  Memory-Regeln vom User > Vendor-Generalisierung > RAG-Vorschlag

# =============================================================================
# SKILLS CONFIGURATION
# =============================================================================

skills:
  # Skill-Verzeichnisse
  directories:
    - "${PLUGIN_PATH}/skills"

  # Verf√ºgbare Skills
  available:
    - name: invoice-explanation
      description: "Beantwortet Fragen zu Rechnungen ohne Workflow"
      trigger: "INVOICE_QUESTION"

    - name: accounting-expert
      description: "Allgemeine Buchhaltungsfragen (Kontierung, Steuerrecht)"
      trigger: "ACCOUNTING_QUESTION"

    - name: smart-booking-auto
      description: "Automatischer Buchungsworkflow (Confidence >=95%)"
      trigger: "INVOICE_PROCESSING"

    - name: smart-booking-hitl
      description: "Human-in-the-Loop Workflow (Confidence <95% oder Hard Gate)"
      trigger: "AUTO_SWITCH"  # Wird automatisch von smart-booking-auto aktiviert

  # Skill-Aktivierung
  activation:
    mode: "intent_based"  # Skills werden basierend auf Intent aktiviert
    auto_switch: true     # Automatischer Wechsel zwischen Skills erlaubt

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

persistence:
  type: file
  work_dir: .taskforce_accounting

# =============================================================================
# AGENT BEHAVIOR CONFIGURATION
# =============================================================================

agent:
  max_steps: 25
  planning_strategy: native_react  # Flexibler, weniger LLM-Calls
  max_parallel_tools: 3            # Parallelisierung aktivieren

# =============================================================================
# LLM CONFIGURATION
# =============================================================================

llm:
  config_path: configs/llm_config.yaml
  default_model: main

# =============================================================================
# TOOL CONFIGURATION
# =============================================================================

tools:
  # Skill activation tool (must be first - LLM calls this after intent recognition)
  - activate_skill

  # Core extraction and validation tools
  - docling_extract
  - invoice_extract
  - calculate_tax
  - audit_log

  # Compliance checker with rules
  - name: check_compliance
    params:
      rules_path: "${PLUGIN_PATH}/configs/accounting/rules/compliance_rules.yaml"

  # Semantic Rules Engine (PRD Phase 1)
  - name: semantic_rule_engine
    params:
      rules_path: "${PLUGIN_PATH}/configs/accounting/rules/"

  - name: confidence_evaluator
    params:
      auto_book_threshold: 0.95
      high_amount_threshold: 5000.0
      critical_accounts: ["1800", "2100"]

  - rag_fallback
  - hitl_review
  - rule_learning

  # Native taskforce tools
  - file_read
  - ask_user
  - send_notification

  - memory


# Unified Memory Configuration
memory:
  store_dir: ".taskforce_accounting/memory.md"

# =============================================================================
# WORKFLOW CONFIGURATION (PRD Phase 1)
# =============================================================================

workflow:
  # Confidence threshold for automatic booking (no HITL required)
  auto_book_threshold: 0.95

  # Hard gates that always trigger HITL review
  hard_gates:
    new_vendor: true
    high_amount_threshold: 5000  # EUR
    critical_accounts:
      - "1800"  # Privatentnahmen
      - "2100"  # Anzahlungen

  # Enable automatic rule learning from high-confidence bookings
  auto_rule_learning: true
  min_confidence_for_rule_learning: 0.95

  # Enable rule learning from HITL corrections
  learn_from_hitl: true

# =============================================================================
# EMBEDDINGS CONFIGURATION (LiteLLM - provider-agnostic)
# =============================================================================

embeddings:
  provider: litellm
  model: azure/text-embedding-3-small  # Azure OpenAI deployment name
  cache_enabled: true
  cache_max_size: 1000

# =============================================================================
# CONTEXT POLICY
# =============================================================================

context_policy:
  max_items: 50
  max_chars_per_item: 8000
  truncation_strategy: "trim_oldest"

# =============================================================================
# CONTEXT MANAGEMENT (Aggressive Compression for Efficiency)
# =============================================================================

context_management:
  summary_threshold: 12          # Komprimiere nach 12 Messages (statt 20)
  compression_trigger: 40000     # Komprimiere bei 40k Tokens (statt 80k)
  max_tool_output_chars: 10000   # K√ºrzere Tool-Outputs (statt 20k)

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

logging:
  level: INFO
  structured: true

# =============================================================================
# LONG-TERM MEMORY CONFIGURATION (via MCP)
# =============================================================================

# mcp_servers:
#   - type: stdio
#     command: npx
#     args:
#       - "-y"
#       - "@modelcontextprotocol/server-memory"
#     env:
#       MEMORY_FILE_PATH: ".taskforce_accounting/.memory/knowledge_graph.jsonl"
#     description: "Accounting knowledge: suppliers, rules, projects, user preferences"
